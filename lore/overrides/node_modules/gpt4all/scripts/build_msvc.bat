@echo off

set "BUILD_TYPE=Release"
set "BUILD_DIR=.\build\win-x64-msvc"
set "LIBS_DIR=.\runtimes\win32-x64"

REM Cleanup env
rmdir /s /q %BUILD_DIR%

REM Create directories
mkdir %BUILD_DIR%
mkdir %LIBS_DIR%

REM Build
REM cmake -DBUILD_SHARED_LIBS=ON -DCMAKE_C_COMPILER="C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Community\\VC\\Tools\\MSVC\\14.29.30133\\bin\\Hostx86\\x64\\cl.exe" -DCMAKE_CXX_COMPILER="C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Community\\VC\\Tools\\MSVC\\14.29.30133\\bin\\Hostx86\\x64\\cl.exe"  -DCMAKE_BUILD_TYPE=%BUILD_TYPE% -S ..\..\gpt4all-backend -B %BUILD_DIR%
cmake -DBUILD_SHARED_LIBS=ON --preset x64 -DCMAKE_BUILD_TYPE=%BUILD_TYPE% -S ..\..\gpt4all-backend -B %BUILD_DIR%

:BUILD
REM Build the project
cmake --preset x64 --build "%BUILD_DIR%" --parallel --config %BUILD_TYPE%

REM Check the exit code of the build command
if %errorlevel% neq 0 (
    echo Build failed. Retrying...
    goto BUILD
)

mkdir runtimes\win32-x64

REM Copy the DLLs to the desired location
del /F /A /Q %LIBS_DIR%
xcopy /Y "%BUILD_DIR%\bin\%BUILD_TYPE%\*.dll" runtimes\win32-x64\native\

echo Batch script execution completed.
